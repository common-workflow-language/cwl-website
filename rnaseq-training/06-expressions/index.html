















<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2022-04-26 15:35:11 +0000">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />
    <link rel="license" href="#license-info" />
    <script type="text/javascript" src="../assets/js/tabs.js"></script>
    <link rel="stylesheet" href="../assets/css/tabs.css">

    
    <meta http-equiv="refresh" content="0; url=https://doc.arvados.org/rnaseq-cwl-training/06-expressions/index.html" />
    

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../assets/favicons/swc/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/favicons/swc/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/favicons/swc/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/favicons/swc/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../assets/favicons/swc/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../assets/favicons/swc/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../assets/favicons/swc/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../assets/favicons/swc/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="Software Carpentry - Getting started with CWL"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="../assets/favicons/swc/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="../assets/favicons/swc/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="../assets/favicons/swc/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="../assets/favicons/swc/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="../assets/favicons/swc/mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <title>
  Dynamic Workflow Behavior &ndash; Getting started with CWL
  </title>

  </head>
  <body>

    


<div class="panel panel-default life-cycle">
  <div id="life-cycle" class="panel-body beta">
    This lesson is being piloted (Beta version)
  </div>
</div>




    <div class="container">
      
















  
  










<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../index.html">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>

        
	
        <li><a href="../setup.html">Setup</a></li>

        
        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            
            <li><a href="../01-introduction/index.html">Introduction</a></li>
            
            
            <li><a href="../02-workflow/index.html">Create a Workflow by Composing Tools</a></li>
            
            
            <li><a href="../03-running/index.html">Running and Debugging a Workflow</a></li>
            
            
            <li><a href="../04-commandlinetool/index.html">Writing a Tool Wrapper</a></li>
            
            
            <li><a href="../05-scatter/index.html">Analyzing Multiple Samples</a></li>
            
            
            <li><a href="../06-expressions/index.html">Dynamic Workflow Behavior</a></li>
            
            
            <li><a href="../07-resources/index.html"> Resources for further learning</a></li>
            
            
            <li><a href="../08-supplement-docker/index.html">Supplement: Creating Docker Images for Workflows</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio/index.html">All in one page (Beta)</a></li>
          </ul>
        </li>
        
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference.html">Reference</a></li>
            
            
            <li><a href="../about/index.html">About</a></li>
            
            
            <li><a href="../discuss/index.html">Discussion</a></li>
            
            
            <li><a href="../figures/index.html">Figures</a></li>
            
            
            <li><a href="../guide/index.html">Instructor Notes</a></li>
            
          </ul>
        </li>
	

	
        <li><a href="../LICENSE.html">License</a></li>
	
	<li><a href="/edit//_episodes/06-expressions.md" data-checker-ignore>Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>




























  
  











<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../05-scatter/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">Getting started with CWL</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../07-resources/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Dynamic Workflow Behavior</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>












<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 20 min
      <br/>
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>What kind of custom logic can happen between steps?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Customize the STAR output filename to use the input filename.</p>
</li>
	
	<li><p>Organize files into directories.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>This lesson has migrated to https://doc.arvados.org/rnaseq-cwl-training/06-expressions/index.html</p>

<h1 id="expressions-on-step-inputs">Expressions on step inputs</h1>

<p>You might have noticed that the output bam files are all named
<code class="language-plaintext highlighter-rouge">Aligned.sortedByCoord.out.bam</code>.  This happens because because when we
call STAR, it gives the output a default file name.</p>

<p>During workflow execution, this is usually not a problem.  The
workflow runner is smart enough to know that these files are different
and keep them separate.  This can even make development easier by not
having to worry about assigning unique file names to every file.
Also, if we intend to discard the BAM files as intermediate results</p>

<p>However, it is a problem for humans interpreting the output.  We can
fix this by setting the parameter <code class="language-plaintext highlighter-rouge">OutFileNamePrefix</code> on STAR.  We
want the output filename to be based on the input filename.</p>

<p>In <code class="language-plaintext highlighter-rouge">alignment.cwl</code>, we can use <code class="language-plaintext highlighter-rouge">valueFrom</code> on the <code class="language-plaintext highlighter-rouge">OutFileNamePrefix</code>
input parameter to construct the output prefix from the input
filename.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">requirements</span><span class="pi">:</span>
  <span class="na">StepInputExpressionRequirement</span><span class="pi">:</span> <span class="pi">{}</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">STAR</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">in</span><span class="pi">:</span>
      <span class="na">ForwardReads</span><span class="pi">:</span> <span class="s">fq</span>
      <span class="s">...</span>
      <span class="na">OutFileNamePrefix</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">valueFrom</span><span class="pi">:</span> <span class="s2">"</span><span class="s">$(inputs.ForwardReads.nameroot)."</span><span class="pi">}</span>
</code></pre></div></div>

<p>The code between <code class="language-plaintext highlighter-rouge">$(...)</code> is called an “expression”.  It is evaluated
when setting up the step to run, and the expression is replaced by the
result to get the parameter value.</p>

<p>An expression can refer to other inputs to the step that are either
directly connected to another value, or have a default value.  Here,
we refer to the input parameter ForwardReads, which is our fastq input
file.</p>

<p>ForwardReads is a File object, not a plain file name, so it has some
fields of its own.  The file object has a number of fields that we can
use.  These include <code class="language-plaintext highlighter-rouge">basename</code> (the name of the file, without a
directory), <code class="language-plaintext highlighter-rouge">size</code> (file size, in bytes), <code class="language-plaintext highlighter-rouge">nameext</code> (the last file
extension) and <code class="language-plaintext highlighter-rouge">nameroot</code> (the name with <code class="language-plaintext highlighter-rouge">nameext</code> removed).  Using</p>

<p>Finally, our expression is embedded in a string, so after replacing
the expression with the value of <code class="language-plaintext highlighter-rouge">inputs.ForwardReads.nameroot</code>, it
adds the remainder of the string, which just is a dot <code class="language-plaintext highlighter-rouge">.</code>.  This is to
separate the leading part of our filename from the “Aligned.bam”
extension that will be added by STAR.</p>

<h1 id="organizing-output-files-into-directories">Organizing output files into Directories</h1>

<p>You probably noticed that all the output files appear in the same
directory.  You might prefer that each file appears in its own
directory.  This will show you how to do that.</p>

<p>Unlike shell scripts, in CWL you cannot call <code class="language-plaintext highlighter-rouge">mkdir</code> and <code class="language-plaintext highlighter-rouge">mv</code> to
organize files into directories.  This is because the output files, at
this point, do not actually exist together in one directory.  They may
exist on different nodes, in different directories, or different cloud
buckets.  In CWL, instead of moving files around directly, you tell
the runner you want your directory to look like, and it will create it
for you.</p>

<p>We can use an “expression” to create a <code class="language-plaintext highlighter-rouge">Directory</code> object describing
each of our directories.  An expression is a piece of Javascript code
which is executed by the workflow runner to produce values that affect
the workflow.  These can be a simple as substituting the value of an
input variable, or as complex as en entire function that generates new
objects.</p>

<p>Javscript code must be bracketed inside <code class="language-plaintext highlighter-rouge">$(...)</code> or <code class="language-plaintext highlighter-rouge">${...}</code>. The
difference comes down to syntax.  The <code class="language-plaintext highlighter-rouge">$()</code> form is more compact but
can only include code that can appear on the right side of an
assignment (<code class="language-plaintext highlighter-rouge">=</code>), which cannot include control blocks like <code class="language-plaintext highlighter-rouge">if</code> or
<code class="language-plaintext highlighter-rouge">for</code>.  The <code class="language-plaintext highlighter-rouge">${}</code> form is a Javascript function, which can include
control blocks, and must end in a <code class="language-plaintext highlighter-rouge">return</code> statement.</p>

<p>Expressions can both appear in <code class="language-plaintext highlighter-rouge">valueFrom</code> fields as well as some
other fields, or in an <code class="language-plaintext highlighter-rouge">ExpressionTool</code> which, like <code class="language-plaintext highlighter-rouge">Workflow</code> or
<code class="language-plaintext highlighter-rouge">CommandLineTool</code> has explicitly defined <code class="language-plaintext highlighter-rouge">inputs</code> and <code class="language-plaintext highlighter-rouge">outputs</code>
sections.</p>

<p>The approach here is to define an expression tool which takes a</p>

<p>The <code class="language-plaintext highlighter-rouge">Directory</code> object has two fields, <code class="language-plaintext highlighter-rouge">basename</code> and <code class="language-plaintext highlighter-rouge">listing</code>.  The
<code class="language-plaintext highlighter-rouge">basename</code> is the name of the directory, and the <code class="language-plaintext highlighter-rouge">listing</code> is the
contents, which consists of other File and Directory objects.</p>

<p>Create <code class="language-plaintext highlighter-rouge">subdirs.cwl</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">cwlVersion</span><span class="pi">:</span> <span class="s">v1.2</span>
<span class="na">class</span><span class="pi">:</span> <span class="s">ExpressionTool</span>
<span class="na">requirements</span><span class="pi">:</span>
  <span class="na">InlineJavascriptRequirement</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="na">inputs</span><span class="pi">:</span>
  <span class="na">fq</span><span class="pi">:</span> <span class="s">File[]</span>
  <span class="na">bams</span><span class="pi">:</span> <span class="s">File[]</span>
  <span class="na">qc</span><span class="pi">:</span> <span class="s">File[]</span>
<span class="na">outputs</span><span class="pi">:</span>
  <span class="na">dirs</span><span class="pi">:</span> <span class="s">Directory[]</span>
<span class="na">expression</span><span class="pi">:</span> <span class="pi">|-</span>
  <span class="s">${</span>
  <span class="s">var dirs = [];</span>
  <span class="s">for (var i = 0; i &lt; inputs.bams.length; i++) {</span>
    <span class="s">dirs.push({</span>
      <span class="s">"class": "Directory",</span>
      <span class="s">"basename": inputs.fq[i].nameroot,</span>
      <span class="s">"listing": [inputs.bams[i], inputs.qc[i]]</span>
    <span class="s">});</span>
  <span class="s">}</span>
  <span class="s">return {"dirs": dirs};</span>
  <span class="s">}</span>
</code></pre></div></div>

<p>Then change <code class="language-plaintext highlighter-rouge">main.cwl</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">steps</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">output-subdirs</span><span class="pi">:</span>
    <span class="na">run</span><span class="pi">:</span> <span class="s">subdirs.cwl</span>
    <span class="na">in</span><span class="pi">:</span>
      <span class="na">fq</span><span class="pi">:</span> <span class="s">fq</span>
      <span class="na">bams</span><span class="pi">:</span> <span class="s">alignment/bam_sorted_indexed</span>
      <span class="na">qc</span><span class="pi">:</span> <span class="s">alignment/qc_html</span>
    <span class="na">out</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">dirs</span><span class="pi">]</span>
<span class="na">outputs</span><span class="pi">:</span>
  <span class="na">dirs</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Directory[]</span>
    <span class="na">outputSource</span><span class="pi">:</span> <span class="s">output-subdirs/dirs</span>
  <span class="na">featurecounts</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">File</span>
    <span class="na">outputSource</span><span class="pi">:</span> <span class="s">featureCounts/featurecounts</span>
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="running-the-workflow">Running the workflow</h2>

  <p>Run the workflow.  Look at the output.  The BAM and fastqc files
should now be organized into directories, with better naming of the
bam files.</p>

</blockquote>

<blockquote class="solution">
  <h2 id="episode-solution">Episode solution</h2>
  <ul>
    <li><a href="../assets/answers/ep6/main.cwl">main.cwl</a></li>
    <li><a href="../assets/answers/ep6/alignment.cwl">alignment.cwl</a></li>
    <li><a href="../assets/answers/ep6/featureCounts.cwl">featureCounts.cwl</a></li>
    <li><a href="../assets/answers/ep6/subdirs.cwl">subdirs.cwl</a></li>
  </ul>
</blockquote>





<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>CWL expressions allow you to use custom logic to determine input parameter values.</p>
</li>
    
    <li><p>CWL ExpressionTool can be used to reshape data, such as declaring directories that should contain output files.</p>
</li>
    
  </ul>
</blockquote>

</article>



























  
  











<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../05-scatter/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../07-resources/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      






<footer>
  <div class="row">
    <div class="col-md-6 license" id="license-info" align="left">
	
	Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2018–2022
	by <a href="https://carpentries.org/">The Carpentries</a>
        <br>
        Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2016–2018
	by <a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
    </div>
    <div class="col-md-6 help-links" align="right">
	
	<a href="/edit//_episodes/06-expressions.md" data-checker-ignore>Edit on GitHub</a>
	
	/
	<a href="/blob//CONTRIBUTING.md" data-checker-ignore>Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob//CITATION" data-checker-ignore>Cite</a>
	/
	<a href="mailto:info@curii.com">Contact</a>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" align="center">
      Using <a href="https://github.com/carpentries/styles/">The Carpentries style</a>
      version <a href="https://github.com/carpentries/styles/releases/tag/v9.5.3">9.5.3</a>.
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
